version: 0.2

phases:
  pre_build:
    commands:
      - echo "Starting Blue-Green deployment process..."
      - echo "Checking current active environment..."
      
      # ç¾åœ¨ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ç’°å¢ƒã‚’ç¢ºèªï¼ˆåˆå›ã¯blueã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
      - |
        CURRENT_ACTIVE=$(aws ssm get-parameter --name "/blue-green-app/active-backend" --query "Parameter.Value" --output text 2>/dev/null || echo "blue")
        echo "Current active environment: $CURRENT_ACTIVE"
      
      # æ¬¡ã®ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆã‚’æ±ºå®š
      - |
        if [ "$CURRENT_ACTIVE" = "blue" ]; then
          DEPLOY_TARGET="green"
          OLD_ENV="blue"
        else
          DEPLOY_TARGET="blue"
          OLD_ENV="green"
        fi
        echo "Deploy target: $DEPLOY_TARGET"
        echo "Old environment: $OLD_ENV"

  build:
    commands:
      - echo "Phase 1: Starting $DEPLOY_TARGET service..."
      
      # 1. æ–°ç’°å¢ƒï¼ˆGreen/Blueï¼‰ã‚’èµ·å‹•
      - |
        aws ecs update-service \
          --cluster blue-green-app-backend-cluster \
          --service blue-green-app-backend-$DEPLOY_TARGET \
          --desired-count 1
      
      # 2. ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¾…æ©Ÿ
      - echo "Phase 2: Waiting for $DEPLOY_TARGET to be healthy..."
      - |
        aws ecs wait services-stable \
          --cluster blue-green-app-backend-cluster \
          --services blue-green-app-backend-$DEPLOY_TARGET \
          --cli-read-timeout 600 \
          --cli-connect-timeout 60

  post_build:
    commands:
      - echo "Phase 3: Switching Service Connect discovery names..."
      
      # 3. Service Connectåˆ‡ã‚Šæ›¿ãˆï¼ˆdiscovery_nameå¤‰æ›´ï¼‰
      - |
        # æ—§ç’°å¢ƒã®discovery_nameã‚’å¤‰æ›´
        aws ecs update-service \
          --cluster blue-green-app-backend-cluster \
          --service blue-green-app-backend-$OLD_ENV \
          --service-connect-configuration '{
            "enabled": true,
            "namespace": "'$(aws servicediscovery list-namespaces --filters Name=TYPE,Values=HTTP --query "Namespaces[?Name=='\''blue-green-app-namespace'\''].Arn" --output text)'",
            "services": [{
              "portName": "backend-port",
              "discoveryName": "backend-'$OLD_ENV'",
              "clientAliases": [{
                "port": 8080,
                "dnsName": "backend-'$OLD_ENV'"
              }]
            }]
          }'
      
      - sleep 10
      
      # æ–°ç’°å¢ƒã®discovery_nameã‚’"backend"ã«å¤‰æ›´
      - |
        aws ecs update-service \
          --cluster blue-green-app-backend-cluster \
          --service blue-green-app-backend-$DEPLOY_TARGET \
          --service-connect-configuration '{
            "enabled": true,
            "namespace": "'$(aws servicediscovery list-namespaces --filters Name=TYPE,Values=HTTP --query "Namespaces[?Name=='\''blue-green-app-namespace'\''].Arn" --output text)'",
            "services": [{
              "portName": "backend-port",
              "discoveryName": "backend",
              "clientAliases": [{
                "port": 8080,
                "dnsName": "backend"
              }]
            }]
          }'
      
      - echo "Phase 4: Waiting for Service Connect switch to complete..."
      - sleep 30
      
      # 4. å‹•ä½œç¢ºèª
      - echo "Phase 5: Testing new deployment..."
      - |
        ALB_URL=$(aws elbv2 describe-load-balancers --names blue-green-app-alb --query "LoadBalancers[0].DNSName" --output text)
        echo "Testing: http://$ALB_URL/api"
        
        # æœ€å¤§5å›ãƒªãƒˆãƒ©ã‚¤
        for i in {1..5}; do
          if curl -f "http://$ALB_URL/api"; then
            echo "âœ… Deployment test successful!"
            break
          else
            echo "âŒ Test failed, retrying... ($i/5)"
            sleep 10
          fi
          
          if [ $i -eq 5 ]; then
            echo "âŒ Deployment test failed after 5 attempts"
            exit 1
          fi
        done
      
      # 5. æ—§ç’°å¢ƒåœæ­¢
      - echo "Phase 6: Stopping old environment ($OLD_ENV)..."
      - |
        aws ecs update-service \
          --cluster blue-green-app-backend-cluster \
          --service blue-green-app-backend-$OLD_ENV \
          --desired-count 0
      
      # 6. ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ç’°å¢ƒã‚’SSMã«ä¿å­˜
      - echo "Phase 7: Updating active environment in SSM..."
      - |
        aws ssm put-parameter \
          --name "/blue-green-app/active-backend" \
          --value "$DEPLOY_TARGET" \
          --overwrite
      
      - echo "ğŸ‰ Blue-Green deployment completed successfully!"
      - echo "Active environment: $DEPLOY_TARGET"

artifacts:
  files:
    - '**/*'